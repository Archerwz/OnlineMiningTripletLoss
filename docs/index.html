---

title: online_triplet_loss

keywords: fastai
sidebar: home_sidebar

summary: "PyTorch conversion of the excellent post on the [same topic in Tensorflow](https://omoindrot.github.io/triplet-loss). Simply an implementation of a triple loss with online mining of candidate triplets used in semi-supervised learning."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install online_triplet_loss</code></p>
<p>Then import with:
<code>from online_triplet_loss.losses import *</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use">&#182;</a></h2><p>In these examples I use a really large margin, since the embedding space is so small. A more realistic margins seems to be between <code>0.1 and 2.0</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span> <span class="c1"># our five labels</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">batch_hard_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([8, 2, 5, 4, 5])
Embeddings: tensor([[-0.8817, -1.0785, -0.3578, -0.0837,  0.2544, -0.8937,  1.4421,  0.2820,
          0.2439,  0.4424],
        [ 0.8939, -1.9193,  0.2663, -0.1702, -0.7696,  1.3117,  1.0242, -1.0406,
          0.2643,  0.2774],
        [ 0.9621, -3.1509,  0.3539,  1.3979, -0.9992,  0.4069,  0.7399,  0.2953,
          0.1055,  1.6277],
        [-0.6303, -0.6868, -0.3235,  1.2629,  0.1715, -0.8287, -0.0056,  0.0165,
         -0.6142,  0.9858],
        [ 0.9621, -3.1509,  0.3539,  1.3979, -0.9992,  0.4069,  0.7399,  0.2953,
          0.1055,  1.6277]], grad_fn=&lt;EmbeddingBackward&gt;)
Loss: tensor(97.3276, grad_fn=&lt;MeanBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span><span class="p">,</span> <span class="n">fraction_pos</span> <span class="o">=</span> <span class="n">batch_all_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([8, 2, 5, 4, 5])
Embeddings: tensor([[-0.8817, -1.0785, -0.3578, -0.0837,  0.2544, -0.8937,  1.4421,  0.2820,
          0.2439,  0.4424],
        [ 0.8939, -1.9193,  0.2663, -0.1702, -0.7696,  1.3117,  1.0242, -1.0406,
          0.2643,  0.2774],
        [ 0.9621, -3.1509,  0.3539,  1.3979, -0.9992,  0.4069,  0.7399,  0.2953,
          0.1055,  1.6277],
        [-0.6303, -0.6868, -0.3235,  1.2629,  0.1715, -0.8287, -0.0056,  0.0165,
         -0.6142,  0.9858],
        [ 0.9621, -3.1509,  0.3539,  1.3979, -0.9992,  0.4069,  0.7399,  0.2953,
          0.1055,  1.6277]], grad_fn=&lt;EmbeddingBackward&gt;)
tensor(96.4817, grad_fn=&lt;DivBackward0&gt;) tensor(1.)
Loss: tensor(96.4817, grad_fn=&lt;DivBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References">&#182;</a></h2><ul>
<li><a href="https://github.com/omoindrot/tensorflow-triplet-loss">Triplet Loss and Online Triplet Mining in Tensorflow</a></li>
<li><a href="https://arxiv.org/abs/1503.03832">Facenet paper</a></li>
<li><a href="https://github.com/adambielski/siamese-triplet">adambielski's nice implementation</a> (unfortunately context switches between CPU / GPU)</li>
</ul>

</div>
</div>
</div>
</div>
 


---

title: online_triplet_loss

keywords: fastai
sidebar: home_sidebar

summary: "PyTorch conversion of the excellent post on the [same topic in Tensorflow](https://omoindrot.github.io/triplet-loss). Simply an implementation of a triple loss with online mining of candidate triplets used in semi-supervised learning."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install online_triplet_loss</code></p>
<p>Then import with:
<code>from online_triplet_loss.losses import *</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use">&#182;</a></h2><p>In these examples I use a really large margin, since the embedding space is so small. A more realistic margins seems to be between <code>0.1 and 2.0</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span> <span class="c1"># our five labels</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">batch_hard_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([0, 7, 7, 5, 5])
Embeddings: tensor([[ 1.7146, -0.3138,  0.1500, -1.3602,  0.6112,  1.9415, -0.0872, -0.5365,
         -0.6287, -1.2523],
        [ 0.3933, -1.9714,  1.7608, -0.4584,  0.9668, -1.4512, -0.2314,  1.8080,
          0.4513, -0.3509],
        [ 0.3933, -1.9714,  1.7608, -0.4584,  0.9668, -1.4512, -0.2314,  1.8080,
          0.4513, -0.3509],
        [-1.3622, -1.2098, -0.4699,  1.3565,  1.4588,  0.7476,  0.1563,  2.0376,
          0.7811, -0.0996],
        [-1.3622, -1.2098, -0.4699,  1.3565,  1.4588,  0.7476,  0.1563,  2.0376,
          0.7811, -0.0996]], grad_fn=&lt;EmbeddingBackward&gt;)
Loss: tensor(95.6246, grad_fn=&lt;MeanBackward1&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span><span class="p">,</span> <span class="n">fraction_pos</span> <span class="o">=</span> <span class="n">batch_all_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([0, 7, 7, 5, 5])
Embeddings: tensor([[ 1.7146, -0.3138,  0.1500, -1.3602,  0.6112,  1.9415, -0.0872, -0.5365,
         -0.6287, -1.2523],
        [ 0.3933, -1.9714,  1.7608, -0.4584,  0.9668, -1.4512, -0.2314,  1.8080,
          0.4513, -0.3509],
        [ 0.3933, -1.9714,  1.7608, -0.4584,  0.9668, -1.4512, -0.2314,  1.8080,
          0.4513, -0.3509],
        [-1.3622, -1.2098, -0.4699,  1.3565,  1.4588,  0.7476,  0.1563,  2.0376,
          0.7811, -0.0996],
        [-1.3622, -1.2098, -0.4699,  1.3565,  1.4588,  0.7476,  0.1563,  2.0376,
          0.7811, -0.0996]], grad_fn=&lt;EmbeddingBackward&gt;)
tensor(95.4382, grad_fn=&lt;DivBackward0&gt;) tensor(1.)
Loss: tensor(95.4382, grad_fn=&lt;DivBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References">&#182;</a></h2><ul>
<li><a href="https://github.com/omoindrot/tensorflow-triplet-loss">Triplet Loss and Online Triplet Mining in Tensorflow</a></li>
<li><a href="https://arxiv.org/abs/1503.03832">Facenet paper</a></li>
<li><a href="https://github.com/adambielski/siamese-triplet">adambielski's nice implementation</a> (unfortunately context switches between CPU / GPU)</li>
</ul>

</div>
</div>
</div>
</div>
 


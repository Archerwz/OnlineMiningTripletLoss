---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: lib/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Online-Mining-Triplet-Loss-for-Pytorch">Online Mining Triplet Loss for Pytorch<a class="anchor-link" href="#Online-Mining-Triplet-Loss-for-Pytorch">&#182;</a></h1><p>PyTorch conversion of the excellent post on the <a href="https://omoindrot.github.io/triplet-loss">same topic in Tensorflow</a>.
Simply an implementation of a triple loss with online mining of candidate triplets used in semi-supervised learning.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install online_triplet_loss</code></p>
<p>Then import with:
<code>from online_triplet_loss.losses import *</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use">&#182;</a></h2><p>In these examples I use a really large margin, since the embedding space is so small. A more realistic margins seems to be between <code>0.1 and 2.0</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span> <span class="c1"># our five labels</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">batch_hard_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([9, 9, 0, 6, 6])
Embeddings: tensor([[ 1.5905,  1.0234,  0.5070, -1.1889, -0.2513,  1.4140, -1.3998, -0.5610,
         -1.8737,  2.1783],
        [ 1.5905,  1.0234,  0.5070, -1.1889, -0.2513,  1.4140, -1.3998, -0.5610,
         -1.8737,  2.1783],
        [-1.3731, -0.9758, -0.8194,  0.7589, -2.7509,  1.5812,  0.7562, -0.7153,
         -2.0529,  0.3074],
        [ 1.4821, -0.6232, -0.1070, -0.3533, -0.5412,  1.6558,  0.6346, -0.0507,
         -1.1239, -1.7728],
        [ 1.4821, -0.6232, -0.1070, -0.3533, -0.5412,  1.6558,  0.6346, -0.0507,
         -1.1239, -1.7728]], grad_fn=&lt;EmbeddingBackward&gt;)
Loss: tensor(95.2992, grad_fn=&lt;MeanBackward1&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from online_triplet_loss.losses import *</span>
<span class="n">embeddings</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels:&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Embeddings:&#39;</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
<span class="n">loss</span><span class="p">,</span> <span class="n">fraction_pos</span> <span class="o">=</span> <span class="n">batch_all_triplet_loss</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loss:&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Labels: tensor([9, 9, 0, 6, 6])
Embeddings: tensor([[ 1.5905,  1.0234,  0.5070, -1.1889, -0.2513,  1.4140, -1.3998, -0.5610,
         -1.8737,  2.1783],
        [ 1.5905,  1.0234,  0.5070, -1.1889, -0.2513,  1.4140, -1.3998, -0.5610,
         -1.8737,  2.1783],
        [-1.3731, -0.9758, -0.8194,  0.7589, -2.7509,  1.5812,  0.7562, -0.7153,
         -2.0529,  0.3074],
        [ 1.4821, -0.6232, -0.1070, -0.3533, -0.5412,  1.6558,  0.6346, -0.0507,
         -1.1239, -1.7728],
        [ 1.4821, -0.6232, -0.1070, -0.3533, -0.5412,  1.6558,  0.6346, -0.0507,
         -1.1239, -1.7728]], grad_fn=&lt;EmbeddingBackward&gt;)
Loss: tensor(94.9889, grad_fn=&lt;DivBackward0&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="References">References<a class="anchor-link" href="#References">&#182;</a></h2><ul>
<li><a href="https://github.com/omoindrot/tensorflow-triplet-loss">Triplet Loss and Online Triplet Mining in Tensorflow</a></li>
<li><a href="https://arxiv.org/abs/1503.03832">Facenet paper</a></li>
<li><a href="https://github.com/adambielski/siamese-triplet">adambielski's nice implementation</a> (unfortunately context switches between CPU / GPU)</li>
</ul>

</div>
</div>
</div>
</div>
 

